<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFmpeg API 测试工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#10b981',
                        accent: '#6366f1',
                        dark: '#1e293b',
                        light: '#f1f5f9',
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-dark mb-2">FFmpeg API 测试工具</h1>
            <p class="text-gray-600">一个简单的前端界面，用于测试后端FFmpeg API功能</p>
        </header>

        <!-- 通知系统 -->
        <div id="notification" class="fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity duration-300 opacity-0 hidden"></div>
        
        <!-- 全局进度条 -->
        <div class="fixed top-0 left-0 w-full h-1 bg-gray-200 z-50 hidden">
            <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-300 ease-out" style="width: 0%"></div>
        </div>

        <!-- API测试选项卡 -->
        <div class="mb-6">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8">
                    <button id="tab-image" class="text-primary border-b-2 border-primary px-1 py-4 font-medium text-sm" onclick="switchTab('image')">图像处理</button>
                    <button id="tab-gif" class="text-gray-500 hover:text-gray-700 px-1 py-4 font-medium text-sm" onclick="switchTab('gif')">GIF处理</button>
                    <button id="tab-video" class="text-gray-500 hover:text-gray-700 px-1 py-4 font-medium text-sm" onclick="switchTab('video')">视频处理</button>
                </nav>
            </div>
        </div>

        <!-- 图像处理API测试 -->
        <div id="section-image" class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-bold mb-4 text-dark">图像处理 API</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-2">选择API</label>
                        <select id="image-api-select" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="chromakey">色度键抠图 (/api/image/chromakey)</option>
                            <option value="advanced-keying">高级抠图 (/api/image/advanced-keying)</option>
                            <option value="crop">图像裁剪 (/api/image/crop)</option>
                            <option value="resize">图像缩放 (/api/image/resize)</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-2">上传图像</label>
                        <input type="file" id="image-upload" accept="image/*" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>

                    <div id="image-params" class="mb-6">
                        <!-- 动态参数区域 -->
                        <div id="params-chromakey">
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">选择模式</label>
                                <select id="chromakey-mode" class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option value="single">单一颜色</option>
                                    <option value="multiple">多颜色</option>
                                </select>
                            </div>
                            
                            <div id="single-color-section" class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">背景颜色</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <select id="chromakey-color" class="p-2 border border-gray-300 rounded-lg">
                                        <option value="green">绿色</option>
                                        <option value="blue">蓝色</option>
                                        <option value="red">红色</option>
                                        <option value="black">黑色</option>
                                        <option value="white">白色</option>
                                        <option value="yellow">黄色</option>
                                        <option value="cyan">青色</option>
                                        <option value="magenta">品红</option>
                                    </select>
                                    <div>
                                        <label class="block text-xs text-gray-500 mb-1">自定义颜色 (可选)</label>
                                        <input type="color" id="chromakey-custom-color" class="w-full h-10 border border-gray-300 rounded-lg">
                                    </div>
                                </div>
                            </div>
                            
                            <div id="multiple-color-section" class="mb-4 hidden">
                                <label class="block text-gray-700 font-medium mb-2">颜色列表</label>
                                <div id="color-list" class="space-y-2 mb-2">
                                    <div class="flex items-center gap-2 color-item">
                                        <select class="color-select p-2 border border-gray-300 rounded-lg flex-grow">
                                            <option value="green">绿色</option>
                                            <option value="blue">蓝色</option>
                                            <option value="red">红色</option>
                                            <option value="black">黑色</option>
                                            <option value="white">白色</option>
                                        </select>
                                        <input type="color" class="color-picker w-10 h-10 border border-gray-300 rounded-lg">
                                        <button type="button" class="remove-color-btn text-red-500 hover:text-red-700" onclick="removeColorItem(this)">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" id="add-color-btn" class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded flex items-center gap-1">
                                    <i class="fa fa-plus"></i> 添加颜色
                                </button>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">颜色相似度 (0-1)</label>
                                <div class="flex items-center gap-2">
                                    <input type="range" min="0" max="1" step="0.05" value="0.3" id="chromakey-similarity-slider" class="w-full">
                                    <input type="number" min="0" max="1" step="0.05" value="0.3" id="chromakey-similarity" class="w-16 p-1 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">混合参数 (0-1)</label>
                                <div class="flex items-center gap-2">
                                    <input type="range" min="0" max="1" step="0.05" value="0.1" id="chromakey-blend-slider" class="w-full">
                                    <input type="number" min="0" max="1" step="0.05" value="0.1" id="chromakey-blend" class="w-16 p-1 border border-gray-300 rounded-lg">
                                </div>
                                <p class="text-xs text-gray-500 mt-1">控制边缘平滑度，值越高边缘越柔和</p>
                            </div>
                        </div>
                        
                        <div id="params-crop" class="hidden">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">宽度</label>
                                    <input type="number" id="crop-width" class="w-full p-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">高度</label>
                                    <input type="number" id="crop-height" class="w-full p-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">起始X坐标</label>
                                    <input type="number" min="0" value="0" id="crop-x" class="w-full p-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">起始Y坐标</label>
                                    <input type="number" min="0" value="0" id="crop-y" class="w-full p-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <div class="mb-2">
                                <label class="block text-xs text-gray-500">留空将保持原始宽高比</label>
                            </div>
                        </div>
                        
                        <div id="params-resize" class="hidden">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">宽度</label>
                                    <input type="number" min="1" id="resize-width" class="w-full p-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">高度</label>
                                    <input type="number" min="1" id="resize-height" class="w-full p-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="keep-aspect-ratio" checked class="rounded text-primary focus:ring-primary">
                                    <span class="text-gray-700">保持宽高比</span>
                                </label>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">缩放质量</label>
                                <select id="resize-quality" class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option value="fast">快速 (低质量)</option>
                                    <option value="medium" selected>中等 (平衡)</option>
                                    <option value="high">高质量 (较慢)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button id="btn-image-process" class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/90 transition-colors" onclick="processImage()">
                        <i class="fa fa-play mr-2"></i>执行处理
                    </button>
                </div>

                <div>
                    <div class="mb-4">
                        <h3 class="text-lg font-medium mb-2">处理结果</h3>
                        <div id="image-result" class="border border-gray-200 rounded-lg p-4 min-h-[200px] bg-gray-50">
                            <p class="text-gray-500 text-center">等待处理...</p>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-medium mb-2">响应数据</h3>
                        <pre id="image-response" class="border border-gray-200 rounded-lg p-4 bg-gray-50 text-sm overflow-auto max-h-[200px]">{}</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- GIF处理API测试 -->
        <div id="section-gif" class="bg-white rounded-lg shadow-md p-6 mb-8 hidden">
            <h2 class="text-xl font-bold mb-4 text-dark">GIF处理 API</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-2">选择API</label>
                        <select id="gif-api-select" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="explode">GIF分解 (/api/gif/explode)</option>
                            <option value="compress">GIF压缩 (/api/gif/compress)</option>
                            <option value="from-video">视频转GIF (/api/gif/from-video)</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-2" id="gif-upload-label">上传GIF</label>
                        <input type="file" id="gif-upload" accept="image/gif" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>

                    <div class="mb-4 hidden" id="video-for-gif-upload-container">
                        <label class="block text-gray-700 font-medium mb-2">上传视频 (用于视频转GIF)</label>
                        <input type="file" id="video-for-gif-upload" accept="video/*" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>

                    <div id="gif-params" class="mb-6">
                        <!-- 动态参数区域 -->
                        <div id="params-from-video" class="mb-6">
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">开始时间 (秒)</label>
                                <input type="number" min="0" value="0" id="gif-start-time" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">持续时间 (秒)</label>
                                <input type="number" min="1" max="60" value="5" id="gif-duration" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">帧率</label>
                                <input type="number" min="1" max="30" value="10" id="gif-fps" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">输出宽度</label>
                                <input type="number" min="10" max="1920" value="480" id="gif-width" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">优化级别</label>
                                <select id="gif-optimize" class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option value="0">无优化</option>
                                    <option value="1">基础优化</option>
                                    <option value="2" selected>标准优化</option>
                                    <option value="3">高级优化</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="params-compress" class="hidden mb-6">
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">压缩质量</label>
                                <div class="flex items-center gap-2">
                                    <input type="range" min="1" max="10" step="1" value="7" id="gif-quality-slider" class="w-full">
                                    <input type="number" min="1" max="10" value="7" id="gif-quality" class="w-16 p-1 border border-gray-300 rounded-lg">
                                </div>
                                <p class="text-xs text-gray-500 mt-1">1=最低质量/最小文件, 10=最高质量/最大文件</p>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">最大宽度</label>
                                <input type="number" min="10" value="640" id="gif-max-width" class="w-full p-2 border border-gray-300 rounded-lg">
                                <p class="text-xs text-gray-500 mt-1">超过此宽度的GIF将被缩放</p>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">最大帧数</label>
                                <input type="number" min="1" value="0" id="gif-max-frames" class="w-full p-2 border border-gray-300 rounded-lg">
                                <p class="text-xs text-gray-500 mt-1">0表示不限制</p>
                            </div>
                        </div>
                    </div>

                    <button id="btn-gif-process" class="w-full bg-secondary text-white py-2 px-4 rounded-lg hover:bg-secondary/90 transition-colors" onclick="processGif()">
                        <i class="fa fa-play mr-2"></i>执行处理
                    </button>
                </div>

                <div>
                    <div class="mb-4">
                        <h3 class="text-lg font-medium mb-2">处理结果</h3>
                        <div id="gif-result" class="border border-gray-200 rounded-lg p-4 min-h-[200px] bg-gray-50">
                            <p class="text-gray-500 text-center">等待处理...</p>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-medium mb-2">响应数据</h3>
                        <pre id="gif-response" class="border border-gray-200 rounded-lg p-4 bg-gray-50 text-sm overflow-auto max-h-[200px]">{}</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- 视频处理API测试 -->
        <div id="section-video" class="bg-white rounded-lg shadow-md p-6 mb-8 hidden">
            <h2 class="text-xl font-bold mb-4 text-dark">视频处理 API</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-2">选择API</label>
                        <select id="video-api-select" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="info">视频信息 (/api/video/info)</option>
                            <option value="convert">视频转换 (/api/video/convert)</option>
                            <option value="trim">视频剪切 (/api/video/trim)</option>
                            <option value="compress">视频压缩 (/api/video/compress)</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-2">上传视频</label>
                        <input type="file" id="video-upload" accept="video/*" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>

                    <div id="video-params" class="mb-6">
                        <!-- 动态参数区域 -->
                        <div id="params-convert">
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">目标格式</label>
                                <select id="convert-format" class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option value="mp4">MP4</option>
                                    <option value="webm">WebM</option>
                                    <option value="avi">AVI</option>
                                    <option value="mov">MOV</option>
                                    <option value="mkv">MKV</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">视频编码器</label>
                                <select id="convert-video-codec" class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option value="auto">自动选择</option>
                                    <option value="h264">H.264</option>
                                    <option value="h265">H.265/HEVC</option>
                                    <option value="vp9">VP9</option>
                                    <option value="vp8">VP8</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">视频质量</label>
                                <div class="flex items-center gap-2">
                                    <input type="range" min="1" max="10" step="1" value="7" id="convert-quality-slider" class="w-full">
                                    <input type="number" min="1" max="10" value="7" id="convert-quality" class="w-16 p-1 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="convert-copy-audio" checked class="rounded text-primary focus:ring-primary">
                                    <span class="text-gray-700">保留音频</span>
                                </label>
                            </div>
                        </div>
                        
                        <div id="params-trim" class="hidden">
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">开始时间</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="number" min="0" value="0" id="trim-start" class="p-2 border border-gray-300 rounded-lg">
                                    <select id="trim-start-format" class="p-2 border border-gray-300 rounded-lg">
                                        <option value="seconds">秒</option>
                                        <option value="timecode">时间码 (HH:MM:SS)</option>
                                    </select>
                                </div>
                                <input type="text" placeholder="例如: 00:01:30" id="trim-start-timecode" class="w-full p-2 border border-gray-300 rounded-lg mt-2 hidden">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">持续时间 (秒)</label>
                                <input type="number" min="0.1" step="0.1" value="10" id="trim-duration" class="w-full p-2 border border-gray-300 rounded-lg">
                                <p class="text-xs text-gray-500 mt-1">0表示到视频结束</p>
                            </div>
                            <div class="mb-4">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="trim-accurate" class="rounded text-primary focus:ring-primary">
                                    <span class="text-gray-700">精确剪切 (较慢)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div id="params-compress" class="hidden">
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">压缩级别</label>
                                <div class="flex items-center gap-2">
                                    <input type="range" min="1" max="5" step="1" value="3" id="compress-level-slider" class="w-full">
                                    <input type="number" min="1" max="5" value="3" id="compress-level" class="w-16 p-1 border border-gray-300 rounded-lg">
                                </div>
                                <p class="text-xs text-gray-500 mt-1">1=轻度压缩, 5=重度压缩</p>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">目标分辨率</label>
                                <select id="compress-resolution" class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option value="original">保持原始</option>
                                    <option value="1080p">1080p</option>
                                    <option value="720p">720p</option>
                                    <option value="480p">480p</option>
                                    <option value="360p">360p</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 font-medium mb-2">视频编码器</label>
                                <select id="compress-codec" class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option value="h264">H.264</option>
                                    <option value="h265">H.265/HEVC</option>
                                    <option value="vp9">VP9</option>
                                </select>
                            </div>
                    </div>

                    <button id="btn-video-process" class="w-full bg-accent text-white py-2 px-4 rounded-lg hover:bg-accent/90 transition-colors" onclick="processVideo()">
                        <i class="fa fa-play mr-2"></i>执行处理
                    </button>
                </div>

                <div>
                    <div class="mb-4">
                        <h3 class="text-lg font-medium mb-2">处理结果</h3>
                        <div id="video-result" class="border border-gray-200 rounded-lg p-4 min-h-[200px] bg-gray-50">
                            <p class="text-gray-500 text-center">等待处理...</p>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-medium mb-2">响应数据</h3>
                        <pre id="video-response" class="border border-gray-200 rounded-lg p-4 bg-gray-50 text-sm overflow-auto max-h-[200px]">{}</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- 服务信息 -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold mb-4 text-dark">服务信息</h2>
            <div id="service-info" class="text-gray-700">
                <p class="mb-2">后端API基础URL: <span id="api-base-url" class="font-mono bg-gray-100 px-2 py-1 rounded">http://localhost:3000</span></p>
                <p class="mb-2">API状态: <span id="api-status" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">未检测</span></p>
                <button id="btn-check-api" class="mt-2 bg-gray-100 hover:bg-gray-200 text-gray-700 py-1 px-3 rounded text-sm" onclick="checkApiStatus()">
                    <i class="fa fa-refresh mr-1"></i>检查API状态
                </button>
            </div>
        </div>
    </div>

    <script>
        // 切换选项卡
        function switchTab(tabName) {
            // 隐藏所有部分
            document.getElementById('section-image').classList.add('hidden');
            document.getElementById('section-gif').classList.add('hidden');
            document.getElementById('section-video').classList.add('hidden');
            
            // 重置所有选项卡样式
            document.getElementById('tab-image').classList.remove('text-primary', 'border-b-2', 'border-primary');
            document.getElementById('tab-image').classList.add('text-gray-500', 'hover:text-gray-700');
            
            document.getElementById('tab-gif').classList.remove('text-primary', 'border-b-2', 'border-primary');
            document.getElementById('tab-gif').classList.add('text-gray-500', 'hover:text-gray-700');
            
            document.getElementById('tab-video').classList.remove('text-primary', 'border-b-2', 'border-primary');
            document.getElementById('tab-video').classList.add('text-gray-500', 'hover:text-gray-700');
            
            // 显示选中的部分并更新样式
            document.getElementById('section-' + tabName).classList.remove('hidden');
            document.getElementById('tab-' + tabName).classList.remove('text-gray-500', 'hover:text-gray-700');
            document.getElementById('tab-' + tabName).classList.add('text-primary', 'border-b-2', 'border-primary');
        }

        // 通知函数
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            
            // 设置样式
            notification.className = 'fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity duration-300';
            
            if (type === 'success') {
                notification.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                notification.classList.add('bg-red-500', 'text-white');
            } else {
                notification.classList.add('bg-blue-500', 'text-white');
            }
            
            // 显示通知
            notification.classList.remove('hidden');
            setTimeout(() => notification.classList.add('opacity-100'), 10);
            
            // 3秒后隐藏
            setTimeout(() => {
                notification.classList.remove('opacity-100');
                setTimeout(() => notification.classList.add('hidden'), 300);
            }, 3000);
        }

        // 显示进度条
        function showProgressBar() {
            const progressContainer = document.getElementById('progress-bar').parentElement;
            progressContainer.classList.remove('hidden');
        }

        // 更新进度条
        function updateProgressBar(percent) {
            document.getElementById('progress-bar').style.width = percent + '%';
        }

        // 隐藏进度条
        function hideProgressBar() {
            const progressContainer = document.getElementById('progress-bar').parentElement;
            setTimeout(() => {
                progressContainer.classList.add('hidden');
                document.getElementById('progress-bar').style.width = '0%';
            }, 500);
        }

        // 检查API状态
        async function checkApiStatus() {
            try {
                updateProgressBar(30);
                showProgressBar();
                
                const response = await fetch('/health', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                updateProgressBar(70);
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('api-status').className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                    document.getElementById('api-status').textContent = '正常';
                    showNotification('API服务正常运行', 'success');
                } else {
                    document.getElementById('api-status').className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
                    document.getElementById('api-status').textContent = '异常';
                    showNotification('API服务状态异常', 'error');
                }
            } catch (error) {
                document.getElementById('api-status').className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
                document.getElementById('api-status').textContent = '无法连接';
                showNotification('无法连接到API服务: ' + error.message, 'error');
            } finally {
                updateProgressBar(100);
                hideProgressBar();
            }
        }

        // 图像处理函数
        async function processImage() {
            const selectedApi = document.getElementById('image-api-select').value;
            const imageFile = document.getElementById('image-upload').files[0];
            
            if (!imageFile) {
                showNotification('请先上传图像文件', 'error');
                return;
            }
            
            try {
                updateProgressBar(10);
                showProgressBar();
                
                const formData = new FormData();
                formData.append('image', imageFile);
                
                // 根据API类型添加参数
                if (selectedApi === 'chromakey') {
                    const mode = document.getElementById('chromakey-mode').value;
                    const similarity = document.getElementById('chromakey-similarity').value;
                    const blend = document.getElementById('chromakey-blend').value;
                    
                    formData.append('similarity', similarity);
                    formData.append('blend', blend);
                    
                    if (mode === 'single') {
                        const color = document.getElementById('chromakey-color').value;
                        const customColor = document.getElementById('chromakey-custom-color').value;
                        
                        // 如果选择了自定义颜色，使用自定义颜色
                        if (customColor && customColor !== '#000000') {
                            formData.append('color', customColor);
                        } else {
                            formData.append('color', color);
                        }
                    } else if (mode === 'multiple') {
                        const colorItems = document.querySelectorAll('.color-item');
                        const colors = [];
                        
                        colorItems.forEach(item => {
                            const colorSelect = item.querySelector('.color-select').value;
                            const colorPicker = item.querySelector('.color-picker').value;
                            
                            // 如果选择了自定义颜色，使用自定义颜色
                            if (colorPicker && colorPicker !== '#000000') {
                                colors.push(colorPicker);
                            } else {
                                colors.push(colorSelect);
                            }
                        });
                        
                        // 发送颜色数组
                        colors.forEach(color => {
                            formData.append('colors', color);
                        });
                    }
                } else if (selectedApi === 'crop') {
                    const width = document.getElementById('crop-width').value;
                    const height = document.getElementById('crop-height').value;
                    const x = document.getElementById('crop-x').value;
                    const y = document.getElementById('crop-y').value;
                    
                    if (width) formData.append('width', width);
                    if (height) formData.append('height', height);
                    if (x) formData.append('x', x);
                    if (y) formData.append('y', y);
                } else if (selectedApi === 'resize') {
                    const width = document.getElementById('resize-width').value;
                    const height = document.getElementById('resize-height').value;
                    const keepAspectRatio = document.getElementById('keep-aspect-ratio').checked;
                    const quality = document.getElementById('resize-quality').value;
                    
                    if (width) formData.append('width', width);
                    if (height) formData.append('height', height);
                    formData.append('keepAspectRatio', keepAspectRatio);
                    formData.append('quality', quality);
                }
                
                updateProgressBar(30);
                
                // 发送请求
                showNotification('正在处理图像...', 'info');
                const response = await fetch(`/api/image/${selectedApi}`, {
                    method: 'POST',
                    body: formData
                });
                
                updateProgressBar(70);
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.statusText}`);
                }
                
                const result = await response.json();
                updateProgressBar(100);
                
                // 显示结果
                document.getElementById('image-response').textContent = JSON.stringify(result, null, 2);
                
                if (result.output_url || result.image_url) {
                    const imageUrl = result.output_url || result.image_url;
                    const resultContainer = document.getElementById('image-result');
                    resultContainer.innerHTML = `
                        <div class="text-center">
                            <img src="${imageUrl}" alt="处理结果" class="max-w-full max-h-[200px] mx-auto">
                            <a href="${imageUrl}" download target="_blank" class="mt-2 inline-block text-primary hover:underline">
                                <i class="fa fa-download mr-1"></i>下载结果
                            </a>
                        </div>
                    `;
                } else {
                    document.getElementById('image-result').innerHTML = `<p class="text-success">处理成功，但无返回图像URL</p>`;
                }
                
                showNotification('图像处理成功', 'success');
            } catch (error) {
                document.getElementById('image-response').textContent = JSON.stringify({ error: error.message }, null, 2);
                document.getElementById('image-result').innerHTML = `<p class="text-red-600">处理失败: ${error.message}</p>`;
                showNotification('处理失败: ' + error.message, 'error');
            } finally {
                hideProgressBar();
            }
        }

        // GIF处理函数
        async function processGif() {
            const selectedApi = document.getElementById('gif-api-select').value;
            let file = null;
            let endpoint = `/${selectedApi}`;
            
            if (selectedApi === 'from-video') {
                file = document.getElementById('video-for-gif-upload').files[0];
                if (!file) {
                    showNotification('请先上传视频文件', 'error');
                    return;
                }
            } else {
                file = document.getElementById('gif-upload').files[0];
                if (!file) {
                    showNotification('请先上传GIF文件', 'error');
                    return;
                }
            }
            
            try {
                updateProgressBar(10);
                showProgressBar();
                
                const formData = new FormData();
                
                if (selectedApi === 'from-video') {
                    formData.append('video', file);
                    const startTime = document.getElementById('gif-start-time').value;
                    const duration = document.getElementById('gif-duration').value;
                    const fps = document.getElementById('gif-fps').value;
                    const width = document.getElementById('gif-width').value;
                    const optimize = document.getElementById('gif-optimize').value;
                    
                    formData.append('startTime', startTime);
                    formData.append('duration', duration);
                    formData.append('fps', fps);
                    formData.append('width', width);
                    formData.append('optimize', optimize);
                    
                    // 如果有GIF文件也一并上传
                    const gifFile = document.getElementById('gif-upload').files[0];
                    if (gifFile) {
                        formData.append('gif', gifFile);
                    }
                } else if (selectedApi === 'compress') {
                    formData.append('gif', file);
                    const quality = document.getElementById('gif-quality').value;
                    const maxWidth = document.getElementById('gif-max-width').value;
                    const maxFrames = document.getElementById('gif-max-frames').value;
                    
                    formData.append('quality', quality);
                    formData.append('maxWidth', maxWidth);
                    formData.append('maxFrames', maxFrames);
                } else {
                    formData.append('gif', file);
                }
                
                updateProgressBar(30);
                
                // 发送请求
                showNotification('正在处理GIF...', 'info');
                const response = await fetch(`/api/gif/${selectedApi}`, {
                    method: 'POST',
                    body: formData
                });
                
                updateProgressBar(70);
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.statusText}`);
                }
                
                const result = await response.json();
                updateProgressBar(100);
                
                // 显示结果
                document.getElementById('gif-response').textContent = JSON.stringify(result, null, 2);
                
                if (result.output_url || result.gif_url) {
                    const gifUrl = result.output_url || result.gif_url;
                    const resultContainer = document.getElementById('gif-result');
                    resultContainer.innerHTML = `
                        <div class="text-center">
                            <img src="${gifUrl}" alt="处理结果" class="max-w-full max-h-[200px] mx-auto">
                            <a href="${gifUrl}" download target="_blank" class="mt-2 inline-block text-primary hover:underline">
                                <i class="fa fa-download mr-1"></i>下载结果
                            </a>
                        </div>
                    `;
                } else if (result.frames && result.frames.length > 0) {
                    // 显示GIF分解的帧
                    const resultContainer = document.getElementById('gif-result');
                    resultContainer.innerHTML = `
                        <div class="text-center mb-2">找到 ${result.frames.length} 帧</div>
                        <div class="grid grid-cols-3 gap-2 max-h-[200px] overflow-y-auto">
                            ${result.frames.map(frame => `
                                <div>
                                    <img src="${frame}" alt="帧" class="max-w-full max-h-[60px] mx-auto">
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    document.getElementById('gif-result').innerHTML = `<p class="text-success">处理成功</p>`;
                }
                
                showNotification('GIF处理成功', 'success');
            } catch (error) {
                document.getElementById('gif-response').textContent = JSON.stringify({ error: error.message }, null, 2);
                document.getElementById('gif-result').innerHTML = `<p class="text-red-600">处理失败: ${error.message}</p>`;
                showNotification('处理失败: ' + error.message, 'error');
            } finally {
                hideProgressBar();
            }
        }

        // 视频处理函数
        async function processVideo() {
            const selectedApi = document.getElementById('video-api-select').value;
            const videoFile = document.getElementById('video-upload').files[0];
            
            if (!videoFile) {
                showNotification('请先上传视频文件', 'error');
                return;
            }
            
            try {
                updateProgressBar(10);
                showProgressBar();
                
                const formData = new FormData();
                formData.append('video', videoFile);
                
                // 根据API类型添加参数
                if (selectedApi === 'convert') {
                    const format = document.getElementById('convert-format').value;
                    const videoCodec = document.getElementById('convert-video-codec').value;
                    const quality = document.getElementById('convert-quality').value;
                    const copyAudio = document.getElementById('convert-copy-audio').checked;
                    
                    formData.append('format', format);
                    formData.append('videoCodec', videoCodec);
                    formData.append('quality', quality);
                    formData.append('copyAudio', copyAudio);
                } else if (selectedApi === 'trim') {
                    const format = document.getElementById('trim-start-format').value;
                    let startTime = 0;
                    
                    if (format === 'timecode') {
                        startTime = document.getElementById('trim-start-timecode').value;
                    } else {
                        startTime = document.getElementById('trim-start').value;
                    }
                    
                    const duration = document.getElementById('trim-duration').value;
                    const accurate = document.getElementById('trim-accurate').checked;
                    
                    formData.append('startTime', startTime);
                    formData.append('duration', duration);
                    formData.append('format', format);
                    formData.append('accurate', accurate);
                } else if (selectedApi === 'compress') {
                    const level = document.getElementById('compress-level').value;
                    const resolution = document.getElementById('compress-resolution').value;
                    const codec = document.getElementById('compress-codec').value;
                    
                    formData.append('level', level);
                    formData.append('resolution', resolution);
                    formData.append('codec', codec);
                }
                
                updateProgressBar(30);
                
                // 发送请求
                showNotification('正在处理视频...', 'info');
                const response = await fetch(`/api/video/${selectedApi}`, {
                    method: 'POST',
                    body: formData
                });
                
                updateProgressBar(70);
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.statusText}`);
                }
                
                const result = await response.json();
                updateProgressBar(100);
                
                // 显示结果
                document.getElementById('video-response').textContent = JSON.stringify(result, null, 2);
                
                if (selectedApi === 'info') {
                    // 显示视频信息
                    const infoHtml = `
                        <div class="space-y-2">
                            <p><strong>文件名:</strong> ${result.filename}</p>
                            <p><strong>格式:</strong> ${result.format}</p>
                            <p><strong>时长:</strong> ${result.duration} 秒</p>
                            <p><strong>分辨率:</strong> ${result.width}x${result.height}</p>
                            <p><strong>比特率:</strong> ${result.bitrate} bps</p>
                            ${result.codec ? `<p><strong>编码器:</strong> ${result.codec}</p>` : ''}
                        </div>
                    `;
                    document.getElementById('video-result').innerHTML = infoHtml;
                } else if (result.output_url || result.video_url) {
                    const videoUrl = result.output_url || result.video_url;
                    const resultContainer = document.getElementById('video-result');
                    resultContainer.innerHTML = `
                        <div class="text-center">
                            <video controls class="max-w-full max-h-[200px] mx-auto">
                                <source src="${videoUrl}" type="video/${selectedApi === 'convert' ? document.getElementById('convert-format').value : 'mp4'}">
                                您的浏览器不支持视频标签
                            </video>
                            <a href="${videoUrl}" download target="_blank" class="mt-2 inline-block text-primary hover:underline">
                                <i class="fa fa-download mr-1"></i>下载结果
                            </a>
                        </div>
                    `;
                } else {
                    document.getElementById('video-result').innerHTML = `<p class="text-success">处理成功</p>`;
                }
                
                showNotification('视频处理成功', 'success');
            } catch (error) {
                document.getElementById('video-response').textContent = JSON.stringify({ error: error.message }, null, 2);
                document.getElementById('video-result').innerHTML = `<p class="text-red-600">处理失败: ${error.message}</p>`;
                showNotification('处理失败: ' + error.message, 'error');
            } finally {
                hideProgressBar();
            }
        }

        // 添加颜色项目函数
        function addColorItem() {
            const colorList = document.getElementById('color-list');
            const newItem = document.createElement('div');
            newItem.className = 'flex items-center gap-2 color-item';
            newItem.innerHTML = `
                <select class="color-select p-2 border border-gray-300 rounded-lg flex-grow">
                    <option value="green">绿色</option>
                    <option value="blue">蓝色</option>
                    <option value="red">红色</option>
                    <option value="black">黑色</option>
                    <option value="white">白色</option>
                    <option value="yellow">黄色</option>
                    <option value="cyan">青色</option>
                    <option value="magenta">品红</option>
                </select>
                <input type="color" class="color-picker w-10 h-10 border border-gray-300 rounded-lg">
                <button type="button" class="remove-color-btn text-red-500 hover:text-red-700" onclick="removeColorItem(this)">
                    <i class="fa fa-trash"></i>
                </button>
            `;
            colorList.appendChild(newItem);
        }
        
        // 移除颜色项目函数
        function removeColorItem(button) {
            const colorList = document.getElementById('color-list');
            const item = button.closest('.color-item');
            if (colorList.children.length > 1) {
                colorList.removeChild(item);
            } else {
                showNotification('至少保留一个颜色', 'info');
            }
        }
        
        // 图像处理API选择变化事件
        document.getElementById('image-api-select').addEventListener('change', function() {
            const selectedApi = this.value;
            
            // 隐藏所有参数区域
            document.getElementById('params-chromakey').classList.add('hidden');
            document.getElementById('params-crop').classList.add('hidden');
            document.getElementById('params-resize').classList.add('hidden');
            
            // 显示选中的参数区域
            if (selectedApi === 'chromakey' || selectedApi === 'advanced-keying') {
                document.getElementById('params-chromakey').classList.remove('hidden');
            } else if (selectedApi === 'crop') {
                document.getElementById('params-crop').classList.remove('hidden');
            } else if (selectedApi === 'resize') {
                document.getElementById('params-resize').classList.remove('hidden');
            }
        });
        
        // 色度键模式变化事件
        document.getElementById('chromakey-mode').addEventListener('change', function() {
            const mode = this.value;
            document.getElementById('single-color-section').classList.toggle('hidden', mode === 'multiple');
            document.getElementById('multiple-color-section').classList.toggle('hidden', mode === 'single');
        });
        
        // 添加颜色按钮点击事件
        document.getElementById('add-color-btn').addEventListener('click', addColorItem);
        
        // 滑块同步事件
        document.getElementById('chromakey-similarity-slider').addEventListener('input', function() {
            document.getElementById('chromakey-similarity').value = this.value;
        });
        document.getElementById('chromakey-similarity').addEventListener('input', function() {
            document.getElementById('chromakey-similarity-slider').value = this.value;
        });
        
        document.getElementById('chromakey-blend-slider').addEventListener('input', function() {
            document.getElementById('chromakey-blend').value = this.value;
        });
        document.getElementById('chromakey-blend').addEventListener('input', function() {
            document.getElementById('chromakey-blend-slider').value = this.value;
        });
        
        // 保持宽高比逻辑
        document.getElementById('keep-aspect-ratio').addEventListener('change', function() {
            if (this.checked) {
                // 如果有一个维度已设置，根据图片计算另一个维度
                const img = new Image();
                const fileInput = document.getElementById('image-upload');
                if (fileInput.files && fileInput.files[0]) {
                    img.src = URL.createObjectURL(fileInput.files[0]);
                    img.onload = function() {
                        const originalRatio = img.width / img.height;
                        const widthInput = document.getElementById('resize-width');
                        const heightInput = document.getElementById('resize-height');
                        
                        if (widthInput.value && !heightInput.value) {
                            heightInput.value = Math.round(widthInput.value / originalRatio);
                        } else if (heightInput.value && !widthInput.value) {
                            widthInput.value = Math.round(heightInput.value * originalRatio);
                        }
                        URL.revokeObjectURL(img.src);
                    };
                }
            }
        });
        
        // 宽度输入变化，保持宽高比
        document.getElementById('resize-width').addEventListener('input', function() {
            if (document.getElementById('keep-aspect-ratio').checked) {
                const width = this.value;
                if (width) {
                    const img = new Image();
                    const fileInput = document.getElementById('image-upload');
                    if (fileInput.files && fileInput.files[0]) {
                        img.src = URL.createObjectURL(fileInput.files[0]);
                        img.onload = function() {
                            const originalRatio = img.width / img.height;
                            document.getElementById('resize-height').value = Math.round(width / originalRatio);
                            URL.revokeObjectURL(img.src);
                        };
                    }
                }
            }
        });
        
        // 高度输入变化，保持宽高比
        document.getElementById('resize-height').addEventListener('input', function() {
            if (document.getElementById('keep-aspect-ratio').checked) {
                const height = this.value;
                if (height) {
                    const img = new Image();
                    const fileInput = document.getElementById('image-upload');
                    if (fileInput.files && fileInput.files[0]) {
                        img.src = URL.createObjectURL(fileInput.files[0]);
                        img.onload = function() {
                            const originalRatio = img.width / img.height;
                            document.getElementById('resize-width').value = Math.round(height * originalRatio);
                            URL.revokeObjectURL(img.src);
                        };
                    }
                }
            }
        });

        // GIF API选择变化事件
        document.getElementById('gif-api-select').addEventListener('change', function() {
            const selectedApi = this.value;
            
            // 隐藏所有参数区域
            document.getElementById('params-from-video').classList.add('hidden');
            document.getElementById('params-compress').classList.add('hidden');
            
            // 控制上传文件类型
            if (selectedApi === 'from-video') {
                document.getElementById('gif-upload-label').textContent = '上传GIF (可选)';
                document.getElementById('video-for-gif-upload-container').classList.remove('hidden');
                document.getElementById('gif-upload').accept = 'image/gif';
                document.getElementById('params-from-video').classList.remove('hidden');
            } else if (selectedApi === 'compress') {
                document.getElementById('gif-upload-label').textContent = '上传GIF';
                document.getElementById('video-for-gif-upload-container').classList.add('hidden');
                document.getElementById('gif-upload').accept = 'image/gif';
                document.getElementById('params-compress').classList.remove('hidden');
            } else {
                document.getElementById('gif-upload-label').textContent = '上传GIF';
                document.getElementById('video-for-gif-upload-container').classList.add('hidden');
                document.getElementById('gif-upload').accept = 'image/gif';
            }
        });
        
        // GIF压缩质量滑块同步
        document.getElementById('gif-quality-slider').addEventListener('input', function() {
            document.getElementById('gif-quality').value = this.value;
        });
        document.getElementById('gif-quality').addEventListener('input', function() {
            document.getElementById('gif-quality-slider').value = this.value;
        });

        // 视频API选择变化事件
        document.getElementById('video-api-select').addEventListener('change', function() {
            const selectedApi = this.value;
            
            // 隐藏所有参数区域
            document.getElementById('params-convert').classList.add('hidden');
            document.getElementById('params-trim').classList.add('hidden');
            document.getElementById('params-compress').classList.add('hidden');
            
            // 显示选中的参数区域
            if (selectedApi === 'convert') {
                document.getElementById('params-convert').classList.remove('hidden');
            } else if (selectedApi === 'trim') {
                document.getElementById('params-trim').classList.remove('hidden');
            } else if (selectedApi === 'compress') {
                document.getElementById('params-compress').classList.remove('hidden');
            }
        });
        
        // 视频转换质量滑块同步
        document.getElementById('convert-quality-slider').addEventListener('input', function() {
            document.getElementById('convert-quality').value = this.value;
        });
        document.getElementById('convert-quality').addEventListener('input', function() {
            document.getElementById('convert-quality-slider').value = this.value;
        });
        
        // 视频压缩级别滑块同步
        document.getElementById('compress-level-slider').addEventListener('input', function() {
            document.getElementById('compress-level').value = this.value;
        });
        document.getElementById('compress-level').addEventListener('input', function() {
            document.getElementById('compress-level-slider').value = this.value;
        });
        
        // 剪切开始时间格式切换
        document.getElementById('trim-start-format').addEventListener('change', function() {
            const format = this.value;
            document.getElementById('trim-start').classList.toggle('hidden', format === 'timecode');
            document.getElementById('trim-start-timecode').classList.toggle('hidden', format !== 'timecode');
        });

        // 初始化
        window.onload = function() {
            // 初始化工具函数
            if (window.ffmpegUtils) {
                window.ffmpegUtils.initUtils();
            }
            
            // 默认显示图像处理选项卡
            switchTab('image');
            
            // 尝试检查API状态
            setTimeout(checkApiStatus, 1000);
        };
    </script>
    <script src="utils.js"></script>
</body>
</html>